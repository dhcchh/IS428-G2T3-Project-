<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Volatility Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js" charset="utf-8"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .controls-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        .etf-control {
            display: flex;
            flex-direction: column;
            min-width: 220px;
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .etf-control label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #444;
        }
        .etf-name {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        .etf-control input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
        }
        .validation-message {
            color: #dc3545;
            text-align: center;
            margin: 10px 0;
            min-height: 20px;
            font-weight: bold;
        }
        .buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        button {
            padding: 10px 20px;
            background-color: #4a6fa5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #3a5a80;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #resetBtn {
            background-color: #6c757d;
        }
        #resetBtn:hover {
            background-color: #5a6268;
        }
        .chart-container {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            pointer-events: none;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
            opacity: 0;
        }
        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin: 15px 0;
        }
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 3px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #6c757d;
        }
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            .etf-control {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Portfolio Volatility Visualization</h1>
        
        <div class="controls-container">
            <div class="controls">
                <div class="etf-control">
                    <label for="spy-weight">SPY Weighting</label>
                    <div class="etf-name">SPDR S&P 500 ETF Trust</div>
                    <input type="number" id="spy-weight" min="0" max="1" step="0.01" value="0.25">
                </div>
                
                <div class="etf-control">
                    <label for="gbtc-weight">GBTC Weighting</label>
                    <div class="etf-name">Grayscale Bitcoin Trust</div>
                    <input type="number" id="gbtc-weight" min="0" max="1" step="0.01" value="0.25">
                </div>
                
                <div class="etf-control">
                    <label for="vug-weight">VUG Weighting</label>
                    <div class="etf-name">Vanguard Growth ETF</div>
                    <input type="number" id="vug-weight" min="0" max="1" step="0.01" value="0.25">
                </div>
                
                <div class="etf-control">
                    <label for="brkb-weight">BRK-B Weighting</label>
                    <div class="etf-name">Berkshire Hathaway Inc. Class B</div>
                    <input type="number" id="brkb-weight" min="0" max="1" step="0.01" value="0.25">
                </div>
            </div>
            
            <div class="validation-message" id="validation-message"></div>
            
            <div class="buttons">
                <button id="updateBtn" disabled>Update Portfolio</button>
                <button id="resetBtn">Reset to Equal Weight</button>
            </div>
        </div>
        
        <div class="legend" id="legend"></div>
        
        <div class="chart-container">
            <div id="chart-area" class="loading">Loading portfolio data...</div>
        </div>
        
        <div class="tooltip" id="tooltip"></div>
    </div>
    
    <script>
        // Configuration
        const apiUrl = 'http://localhost:5000/portfolio-data';
        const margin = { top: 50, right: 80, bottom: 60, left: 60 };
        const width = Math.min(1100, window.innerWidth - 100) - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;
        
        // Color scheme
        const colorScheme = {
            'portfolio_volatility': '#e74c3c',
            'SPY': '#1f77b4'
        };
        
        // State variables
        let svg, xScale, yScale, xAxis, yAxis, tooltip;
        let volatilityLine, spyVolatilityLine;
        let portfolioData = [];
        let componentData = {};
        let volatilityData = [];
        let spyVolatilityData = [];
        let updateInProgress = false;
        
        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            validateWeights();
            initChart();
            updatePortfolioData();
        });
        
        // Setup event listeners
        function setupEventListeners() {
            // Weight input listeners
            document.getElementById('spy-weight').addEventListener('input', validateWeights);
            document.getElementById('gbtc-weight').addEventListener('input', validateWeights);
            document.getElementById('vug-weight').addEventListener('input', validateWeights);
            document.getElementById('brkb-weight').addEventListener('input', validateWeights);
            
            // Update button
            document.getElementById('updateBtn').addEventListener('click', () => {
                if (!updateInProgress) {
                    updatePortfolioData();
                }
            });
            
            // Reset button
            document.getElementById('resetBtn').addEventListener('click', resetToEqual);
        }
        
        // Validate weights
        function validateWeights() {
            const spyWeight = parseFloat(document.getElementById('spy-weight').value) || 0;
            const gbtcWeight = parseFloat(document.getElementById('gbtc-weight').value) || 0;
            const vugWeight = parseFloat(document.getElementById('vug-weight').value) || 0;
            const brkbWeight = parseFloat(document.getElementById('brkb-weight').value) || 0;
            
            const sum = spyWeight + gbtcWeight + vugWeight + brkbWeight;
            const validationMessage = document.getElementById('validation-message');
            const updateBtn = document.getElementById('updateBtn');
            
            // Check if any weights are negative
            if (spyWeight < 0 || gbtcWeight < 0 || vugWeight < 0 || brkbWeight < 0) {
                validationMessage.textContent = 'All weights must be positive values.';
                updateBtn.disabled = true;
                return false;
            }
            
            // Check if weights sum to 1
            if (Math.abs(sum - 1) > 0.01) {
                validationMessage.textContent = `Weights must sum to 1. Current sum: ${sum.toFixed(2)}`;
                updateBtn.disabled = true;
                return false;
            }
            
            // Valid weights
            validationMessage.textContent = '';
            updateBtn.disabled = false;
            return true;
        }
        
        // Reset weights to equal
        function resetToEqual() {
            document.getElementById('spy-weight').value = 0.25;
            document.getElementById('gbtc-weight').value = 0.25;
            document.getElementById('vug-weight').value = 0.25;
            document.getElementById('brkb-weight').value = 0.25;
            validateWeights();
            updatePortfolioData();
        }
        
        // Initialize chart
        function initChart() {
            // Clear previous chart
            document.getElementById('chart-area').innerHTML = '';
            document.getElementById('chart-area').classList.remove('loading');
            
            // Create SVG element
            svg = d3.select('#chart-area')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Initialize scales
            xScale = d3.scaleTime().range([0, width]);
            yScale = d3.scaleLinear().range([height, 0]);
            
            // Initialize axes
            xAxis = svg.append('g')
                .attr('class', 'x-axis')
                .attr('transform', `translate(0,${height})`);
                
            yAxis = svg.append('g')
                .attr('class', 'y-axis');
            
            // Add grid lines
            svg.append('g')
                .attr('class', 'grid')
                .style('stroke', '#e0e0e0')
                .style('stroke-opacity', 0.7)
                .style('shape-rendering', 'crispEdges')
                .style('stroke-dasharray', '3,3');
            
            // Add axes labels
            svg.append('text')
                .attr('class', 'x-axis-label')
                .attr('text-anchor', 'middle')
                .attr('x', width / 2)
                .attr('y', height + margin.bottom - 10)
                .text('Date')
                .style('fill', '#666');
                
            svg.append('text')
                .attr('class', 'y-axis-label')
                .attr('text-anchor', 'middle')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', -margin.left + 15)
                .text('Volatility (%)')
                .style('fill', '#666');
            
            // Add chart title
            svg.append('text')
                .attr('class', 'chart-title')
                .attr('text-anchor', 'middle')
                .attr('x', width / 2)
                .attr('y', -margin.top / 2)
                .text('Portfolio Volatility')
                .style('font-size', '18px')
                .style('font-weight', 'bold')
                .style('fill', '#2c3e50');
            
            // Initialize tooltip
            tooltip = d3.select('#tooltip');
            
            // Initialize portfolio volatility line
            volatilityLine = svg.append('path')
                .attr('class', 'volatility-line')
                .style('fill', 'none')
                .style('stroke', colorScheme.portfolio_volatility)
                .style('stroke-width', 3)
                .style('opacity', 0.8);
                
            // Initialize SPY volatility line
            spyVolatilityLine = svg.append('path')
                .attr('class', 'spy-volatility-line')
                .style('fill', 'none')
                .style('stroke', colorScheme.SPY)
                .style('stroke-width', 1.5)
                .style('stroke-dasharray', '5,5')
                .style('opacity', 0.8);
                
            // Init legend
            updateLegend();
        }
        
        // Update portfolio data
        async function updatePortfolioData() {
            if (updateInProgress) return;
            updateInProgress = true;
            
            const spyWeight = parseFloat(document.getElementById('spy-weight').value) || 0;
            const gbtcWeight = parseFloat(document.getElementById('gbtc-weight').value) || 0;
            const vugWeight = parseFloat(document.getElementById('vug-weight').value) || 0;
            const brkbWeight = parseFloat(document.getElementById('brkb-weight').value) || 0;
            
            // Show loading state
            document.getElementById('chart-area').innerHTML = '<div class="loading">Loading portfolio data...</div>';
            
            // Prepare portfolio data
            const portfolio = {
                tickers: {
                    'SPY': spyWeight,
                    'GBTC': gbtcWeight,
                    'VUG': vugWeight,
                    'BRK-B': brkbWeight
                }
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(portfolio)
                });
                
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Update data
                portfolioData = data.portfolio_data;
                componentData = data.component_data;
                
                // Calculate volatility
                volatilityData = calculateVolatility(portfolioData, 'portfolio_value');
                spyVolatilityData = calculateVolatility(componentData['SPY'], 'normalized_price');
                
                // Re-initialize chart (clears loading state)
                initChart();
                
                // Update chart with new data
                updateChart(volatilityData, spyVolatilityData);
                
            } catch (error) {
                console.error('Error fetching portfolio data:', error);
                document.getElementById('chart-area').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <div style="font-weight: bold; margin-bottom: 10px;">Error Loading Data</div>
                        <div>${error.message}</div>
                        <div style="margin-top: 15px; font-size: 14px;">
                            Make sure the Flask microservice is running at ${apiUrl}
                        </div>
                    </div>
                `;
            } finally {
                updateInProgress = false;
            }
        }
        
        // Calculate volatility from price data
        function calculateVolatility(priceData, valueField) {
            if (!priceData || priceData.length < 2) {
                return [];
            }
            
            const volatilityData = [];
            const windowSize = 20; // Fixed window size for volatility calculation
            
            // Calculate daily returns
            const returns = [];
            for (let i = 1; i < priceData.length; i++) {
                const prevValue = priceData[i-1][valueField];
                const currentValue = priceData[i][valueField];
                const dailyReturn = ((currentValue / prevValue) - 1) * 100;
                
                returns.push({
                    date: new Date(priceData[i].date),
                    return: dailyReturn
                });
            }
            
            // Calculate volatility (20-day rolling window)
            for (let i = windowSize - 1; i < returns.length; i++) {
                const windowReturns = returns.slice(i - windowSize + 1, i + 1).map(d => d.return);
                const stdDev = standardDeviation(windowReturns);
                const annualizedVol = stdDev * Math.sqrt(252); // Annualize daily volatility
                
                volatilityData.push({
                    date: returns[i].date,
                    volatility: annualizedVol
                });
            }
            
            return volatilityData;
        }
        
        // Helper function to calculate standard deviation
        function standardDeviation(values) {
            const avg = average(values);
            const squareDiffs = values.map(value => {
                const diff = value - avg;
                return diff * diff;
            });
            const avgSquareDiff = average(squareDiffs);
            return Math.sqrt(avgSquareDiff);
        }
        
        // Helper function to calculate average
        function average(data) {
            const sum = data.reduce((sum, value) => sum + value, 0);
            return sum / data.length;
        }
        
        // Update chart with new data
        function updateChart(volatilityData, spyVolatilityData) {
            if (!volatilityData || volatilityData.length === 0) return;
            
            // Update domains
            const dateExtent = d3.extent(volatilityData, d => d.date);
            xScale.domain(dateExtent);
            
            // Find max volatility for y-axis
            let maxVolatility = d3.max(volatilityData, d => d.volatility);
            const spyMaxVolatility = d3.max(spyVolatilityData, d => d.volatility);
            maxVolatility = Math.max(maxVolatility, spyMaxVolatility);
            
            // Add padding to y-axis
            yScale.domain([0, maxVolatility * 1.1]);
            
            // Update axes
            xAxis.call(
                d3.axisBottom(xScale)
                .ticks(width > 600 ? 10 : 5)
                .tickFormat(d3.timeFormat('%b %Y'))
            );
            
            yAxis.call(
                d3.axisLeft(yScale)
                .ticks(10)
                .tickFormat(d => d3.format('.1f')(d) + '%')
            );
            
            // Update grid lines
            svg.select('.grid')
                .call(
                    d3.axisLeft(yScale)
                    .ticks(10)
                    .tickSize(-width)
                    .tickFormat('')
                );
            
            // Line generator for portfolio volatility
            const line = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.volatility))
                .curve(d3.curveCatmullRom);
            
            // Update portfolio volatility line
            volatilityLine
                .datum(volatilityData)
                .transition()
                .duration(750)
                .attr('d', line);
                
            // Line generator for SPY volatility
            const spyLine = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.volatility))
                .curve(d3.curveCatmullRom);
                
            // Update SPY volatility line
            spyVolatilityLine
                .datum(spyVolatilityData)
                .transition()
                .duration(750)
                .attr('d', spyLine);
            
            // Add interactive elements
            addInteractivity(volatilityData, spyVolatilityData);
        }
        
        // Add interactivity to chart
        function addInteractivity(volatilityData, spyVolatilityData) {
            // Remove previous elements if they exist
            svg.selectAll('.overlay').remove();
            svg.selectAll('.focus').remove();
            
            // Create overlay for mouse events
            svg.append('rect')
                .attr('class', 'overlay')
                .attr('width', width)
                .attr('height', height)
                .style('fill', 'none')
                .style('pointer-events', 'all')
                .on('mousemove', mousemove)
                .on('mouseout', function() {
                    tooltip.style('opacity', 0);
                });
            
            function mousemove(event) {
                const x0 = xScale.invert(d3.pointer(event)[0]);
                const bisectDate = d3.bisector(d => d.date).left;
                const i = bisectDate(volatilityData, x0, 1);
                
                if (i >= volatilityData.length) return;
                
                const d0 = volatilityData[i - 1];
                const d1 = volatilityData[i];
                const d = x0 - d0.date > d1.date - x0 ? d1 : d0;
                
                // Find SPY data point
                const spyI = bisectDate(spyVolatilityData, x0, 1);
                let spyVolatility = null;
                
                if (spyI < spyVolatilityData.length && spyI > 0) {
                    const sd0 = spyVolatilityData[spyI - 1];
                    const sd1 = spyVolatilityData[spyI];
                    const sd = x0 - sd0.date > sd1.date - x0 ? sd1 : sd0;
                    spyVolatility = sd.volatility;
                }
                
                // Format date for tooltip
                const formattedDate = d3.timeFormat('%b %d, %Y')(d.date);
                
                // Create tooltip content
                let tooltipContent = `<div style="font-weight:bold;margin-bottom:5px;">${formattedDate}</div>`;
                tooltipContent += `<div style="margin-bottom:8px;font-weight:bold;">Portfolio Volatility: ${d.volatility.toFixed(2)}%</div>`;
                
                if (spyVolatility !== null) {
                    tooltipContent += `<div>S&P 500 Volatility: ${spyVolatility.toFixed(2)}%</div>`;
                }
                
                // Position and show tooltip
                tooltip
                    .html(tooltipContent)
                    .style('left', (event.pageX + 15) + 'px')
                    .style('top', (event.pageY - 28) + 'px')
                    .style('opacity', 1);
            }
        }
        
        // Update legend
        function updateLegend() {
            const legend = d3.select('#legend');
            legend.html('');
            
            // Portfolio legend item
            const portfolioItem = legend.append('div')
                .attr('class', 'legend-item');
                
            portfolioItem.append('div')
                .attr('class', 'legend-color')
                .style('background-color', colorScheme.portfolio_volatility);
                
            portfolioItem.append('span')
                .text('Portfolio Volatility');
            
            // SPY legend item
            const spyItem = legend.append('div')
                .attr('class', 'legend-item');
                
            spyItem.append('div')
                .attr('class', 'legend-color')
                .style('background-color', colorScheme.SPY);
                
            spyItem.append('span')
                .text('S&P 500 Volatility');
        }
    </script>
</body>
</html>