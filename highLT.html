<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF Portfolio Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js" charset="utf-8"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .controls-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        .etf-control {
            display: flex;
            flex-direction: column;
            min-width: 220px;
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .etf-control label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #444;
        }
        .etf-name {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        .etf-control input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
        }
        .validation-message {
            color: #dc3545;
            text-align: center;
            margin: 10px 0;
            min-height: 20px;
            font-weight: bold;
        }
        .buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        button {
            padding: 10px 20px;
            background-color: #4a6fa5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #3a5a80;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #resetBtn {
            background-color: #6c757d;
        }
        #resetBtn:hover {
            background-color: #5a6268;
        }
        .timeframe-controls {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 15px 0;
        }
        .timeframe-btn {
            padding: 6px 12px;
            background-color: #f8f9fa;
            color: #495057;
            border: 1px solid #ced4da;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .timeframe-btn:hover {
            background-color: #e9ecef;
        }
        .timeframe-btn.active {
            background-color: #4a6fa5;
            color: white;
            border-color: #4a6fa5;
        }
        .chart-container {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            pointer-events: none;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin: 15px 0;
        }
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 3px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #6c757d;
        }
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            .etf-control {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Portfolio vs. S&P 500 Visualization</h1>
        
        <div class="controls-container">
            <div class="controls">
                <div class="etf-control">
                    <label for="spy-weight">SPY Weighting</label>
                    <div class="etf-name">SPDR S&P 500 ETF Trust</div>
                    <input type="number" id="spy-weight" min="0" max="1" step="0.01" value="0.25">
                </div>
                
                <div class="etf-control">
                    <label for="gbtc-weight">GBTC Weighting</label>
                    <div class="etf-name">Grayscale Bitcoin Trust</div>
                    <input type="number" id="gbtc-weight" min="0" max="1" step="0.01" value="0.25">
                </div>
                
                <div class="etf-control">
                    <label for="vug-weight">VUG Weighting</label>
                    <div class="etf-name">Vanguard Growth ETF</div>
                    <input type="number" id="vug-weight" min="0" max="1" step="0.01" value="0.25">
                </div>
                
                <div class="etf-control">
                    <label for="brkb-weight">BRK-B Weighting</label>
                    <div class="etf-name">Berkshire Hathaway Inc. Class B</div>
                    <input type="number" id="brkb-weight" min="0" max="1" step="0.01" value="0.25">
                </div>
            </div>
            
            <div class="validation-message" id="validation-message"></div>
            
            <div class="buttons">
                <button id="updateBtn" disabled>Update Portfolio</button>
                <button id="resetBtn">Reset to Equal Weight</button>
            </div>
        </div>
        
        <div class="legend" id="legend"></div>
        
        <div class="chart-container">
            <div id="chart-area" class="loading">Loading portfolio data...</div>
        </div>
        
        <div class="tooltip" id="tooltip"></div>
    </div>
    
    <script>
        // Configuration
        const apiUrl = 'http://localhost:5000/portfolio-data';
        const margin = { top: 50, right: 80, bottom: 60, left: 60 };
        const width = Math.min(1100, window.innerWidth - 100) - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;
        
        // Color scheme
        const colorScheme = {
            'SPY': '#1f77b4',
            'GBTC': '#ff7f0e', 
            'VUG': '#2ca02c',
            'BRK-B': '#d62728',
            'portfolio_value': '#2c3e50'
        };
        
        // Ticker name mapping
        const tickerNames = {
            'SPY': 'SPDR S&P 500 ETF',
            'GBTC': 'Grayscale Bitcoin Trust',
            'VUG': 'Vanguard Growth ETF',
            'BRK-B': 'Berkshire Hathaway'
        };
        
        // State variables
        let svg, xScale, yScale, xAxis, yAxis, tooltip;
        let portfolioLine, componentLines = {};
        let portfolioData = [];
        let componentData = {};
        let updateInProgress = false;
        
        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            validateWeights();
            initChart();
            updatePortfolioData();
        });
        
        // Setup event listeners
        function setupEventListeners() {
            // Weight input listeners
            document.getElementById('spy-weight').addEventListener('input', validateWeights);
            document.getElementById('gbtc-weight').addEventListener('input', validateWeights);
            document.getElementById('vug-weight').addEventListener('input', validateWeights);
            document.getElementById('brkb-weight').addEventListener('input', validateWeights);
            
            // Update button
            document.getElementById('updateBtn').addEventListener('click', () => {
                if (!updateInProgress) {
                    updatePortfolioData();
                }
            });
            
            // Reset button
            document.getElementById('resetBtn').addEventListener('click', resetToEqual);
            
            // Handle resize
            window.addEventListener('resize', debounce(() => {
                initChart();
                if (portfolioData.length > 0) {
                    updateChart(portfolioData, componentData);
                }
            }, 250));
        }
        
        // Validate weights
        function validateWeights() {
            const spyWeight = parseFloat(document.getElementById('spy-weight').value) || 0;
            const gbtcWeight = parseFloat(document.getElementById('gbtc-weight').value) || 0;
            const vugWeight = parseFloat(document.getElementById('vug-weight').value) || 0;
            const brkbWeight = parseFloat(document.getElementById('brkb-weight').value) || 0;
            
            const sum = spyWeight + gbtcWeight + vugWeight + brkbWeight;
            const validationMessage = document.getElementById('validation-message');
            const updateBtn = document.getElementById('updateBtn');
            
            // Check if any weights are negative
            if (spyWeight < 0 || gbtcWeight < 0 || vugWeight < 0 || brkbWeight < 0) {
                validationMessage.textContent = 'All weights must be positive values.';
                updateBtn.disabled = true;
                return false;
            }
            
            // Check if weights sum to 1
            if (Math.abs(sum - 1) > 0.01) {
                validationMessage.textContent = `Weights must sum to 1. Current sum: ${sum.toFixed(2)}`;
                updateBtn.disabled = true;
                return false;
            }
            
            // Valid weights
            validationMessage.textContent = '';
            updateBtn.disabled = false;
            return true;
        }
        
        // Reset weights to equal
        function resetToEqual() {
            document.getElementById('spy-weight').value = 0.25;
            document.getElementById('gbtc-weight').value = 0.25;
            document.getElementById('vug-weight').value = 0.25;
            document.getElementById('brkb-weight').value = 0.25;
            validateWeights();
            updatePortfolioData();
        }
        
        // Initialize chart
        function initChart() {
            // Clear previous chart
            document.getElementById('chart-area').innerHTML = '';
            document.getElementById('chart-area').classList.remove('loading');
            
            // Create SVG element
            svg = d3.select('#chart-area')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Initialize scales
            xScale = d3.scaleTime().range([0, width]);
            yScale = d3.scaleLinear().range([height, 0]);
            
            // Initialize axes
            xAxis = svg.append('g')
                .attr('class', 'x-axis')
                .attr('transform', `translate(0,${height})`);
                
            yAxis = svg.append('g')
                .attr('class', 'y-axis');
            
            // Add grid lines
            svg.append('g')
                .attr('class', 'grid')
                .style('stroke', '#e0e0e0')
                .style('stroke-opacity', 0.7)
                .style('shape-rendering', 'crispEdges')
                .style('stroke-dasharray', '3,3');
            
            // Add axes labels
            svg.append('text')
                .attr('class', 'x-axis-label')
                .attr('text-anchor', 'middle')
                .attr('x', width / 2)
                .attr('y', height + margin.bottom - 10)
                .text('Date')
                .style('fill', '#666');
                
            svg.append('text')
                .attr('class', 'y-axis-label')
                .attr('text-anchor', 'middle')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', -margin.left + 15)
                .text('Value (Normalized)')
                .style('fill', '#666');
            
            // Add chart title
            svg.append('text')
                .attr('class', 'chart-title')
                .attr('text-anchor', 'middle')
                .attr('x', width / 2)
                .attr('y', -margin.top / 2)
                .text('Portfolio vs. S&P 500 Performance')
                .style('font-size', '18px')
                .style('font-weight', 'bold')
                .style('fill', '#2c3e50');
            
            // Initialize tooltip
            tooltip = d3.select('#tooltip');
            
            // Initialize portfolio line
            portfolioLine = svg.append('path')
                .attr('class', 'portfolio-line')
                .style('fill', 'none')
                .style('stroke', colorScheme.portfolio_value)
                .style('stroke-width', 3)
                .style('opacity', 0.8);
                
            // Init legend
            updateLegend();
        }
        
        // Update portfolio data
        async function updatePortfolioData() {
            if (updateInProgress) return;
            updateInProgress = true;
            
            const spyWeight = parseFloat(document.getElementById('spy-weight').value) || 0;
            const gbtcWeight = parseFloat(document.getElementById('gbtc-weight').value) || 0;
            const vugWeight = parseFloat(document.getElementById('vug-weight').value) || 0;
            const brkbWeight = parseFloat(document.getElementById('brkb-weight').value) || 0;
            
            // Show loading state
            document.getElementById('chart-area').innerHTML = '<div class="loading">Loading portfolio data...</div>';
            
            // Prepare portfolio data
            const portfolio = {
                tickers: {
                    'SPY': spyWeight,
                    'GBTC': gbtcWeight,
                    'VUG': vugWeight,
                    'BRK-B': brkbWeight
                }
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(portfolio)
                });
                
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Update data
                portfolioData = data.portfolio_data;
                componentData = data.component_data;
                
                // Re-initialize chart (clears loading state)
                initChart();
                
                // Update chart with new data
                updateChart(portfolioData, componentData);
                
            } catch (error) {
                console.error('Error fetching portfolio data:', error);
                document.getElementById('chart-area').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <div style="font-weight: bold; margin-bottom: 10px;">Error Loading Data</div>
                        <div>${error.message}</div>
                        <div style="margin-top: 15px; font-size: 14px;">
                            Make sure the Flask microservice is running at ${apiUrl}
                        </div>
                    </div>
                `;
            } finally {
                updateInProgress = false;
            }
        }
        
        // Update chart with new data
        function updateChart(portfolioData, componentData) {
            if (!portfolioData || portfolioData.length === 0) return;
            
            // Convert string dates to Date objects
            portfolioData.forEach(d => d.date = new Date(d.date));
            Object.keys(componentData).forEach(ticker => {
                componentData[ticker].forEach(d => d.date = new Date(d.date));
            });
            
            // Update domains
            const dateExtent = d3.extent(portfolioData, d => d.date);
            xScale.domain(dateExtent);
            
            // We only need to compare portfolio with SPY
            const spyData = componentData['SPY'];
            let maxValue = d3.max(portfolioData, d => d.portfolio_value);
            const spyMax = d3.max(spyData, d => d.normalized_price);
            maxValue = Math.max(maxValue, spyMax);
            
            // Add 10% padding to y-axis
            yScale.domain([0, maxValue * 1.1]);
            
            // Update axes
            xAxis.call(
                d3.axisBottom(xScale)
                .ticks(width > 600 ? 10 : 5)
                .tickFormat(d3.timeFormat('%b %Y'))
            );
            
            yAxis.call(
                d3.axisLeft(yScale)
                .ticks(10)
                .tickFormat(d => d3.format('.1f')(d))
            );
            
            // Update grid lines
            svg.select('.grid')
                .call(
                    d3.axisLeft(yScale)
                    .ticks(10)
                    .tickSize(-width)
                    .tickFormat('')
                );
            
            // Line generator for portfolio
            const line = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.portfolio_value))
                .curve(d3.curveMonotoneX);
            
            // Update portfolio line
            portfolioLine
                .datum(portfolioData)
                .transition()
                .duration(750)
                .attr('d', line);
            
            // Remove old component lines
            svg.selectAll('.component-line').remove();
            
            // Only add SPY line
            const spyLine = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.normalized_price))
                .curve(d3.curveMonotoneX);
            
            svg.append('path')
                .datum(spyData)
                .attr('class', 'component-line')
                .attr('data-ticker', 'SPY')
                .style('fill', 'none')
                .style('stroke', colorScheme['SPY'])
                .style('stroke-width', 1.5)
                .style('opacity', 0.6)
                .attr('d', spyLine);
            
            // Add interactive elements
            addInteractivity();
            
            // Update legend
            updateLegend();
        }
        
        // Add interactivity to chart
        function addInteractivity() {
            // Remove previous elements if they exist
            svg.selectAll('.overlay').remove();
            svg.selectAll('.focus').remove();
            
            // Create focus element for tooltip
            const focus = svg.append('g')
                .attr('class', 'focus')
                .style('display', 'none');
                
            // Add circle to focus
            focus.append('circle')
                .attr('r', 5)
                .style('fill', 'none')
                .style('stroke', '#2c3e50')
                .style('stroke-width', 2);
            
            // Add vertical line
            focus.append('line')
                .attr('class', 'focus-line')
                .attr('y1', 0)
                .attr('y2', height)
                .style('stroke', '#2c3e50')
                .style('stroke-width', 1)
                .style('stroke-dasharray', '3,3')
                .style('opacity', 0.5);
                
            // Create overlay for mouse events
            svg.append('rect')
                .attr('class', 'overlay')
                .attr('width', width)
                .attr('height', height)
                .style('fill', 'none')
                .style('pointer-events', 'all')
                .on('mouseover', () => {
                    focus.style('display', null);
                    tooltip.style('opacity', 1);
                })
                .on('mouseout', () => {
                    focus.style('display', 'none');
                    tooltip.style('opacity', 0);
                })
                .on('mousemove', mousemove);
            
            function mousemove(event) {
                // Get x position in data space
                const x0 = xScale.invert(d3.pointer(event)[0]);
                
                // Find closest data point
                const bisectDate = d3.bisector(d => d.date).left;
                const i = bisectDate(portfolioData, x0, 1);
                
                // Handle edge cases
                if (i >= portfolioData.length) return;
                
                const d0 = portfolioData[i - 1];
                const d1 = portfolioData[i];
                const d = x0 - d0.date > d1.date - x0 ? d1 : d0;
                
                // Update focus position
                const xPos = xScale(d.date);
                focus.attr('transform', `translate(${xPos},${yScale(d.portfolio_value)})`);
                
                // Update vertical line
                focus.select('.focus-line')
                    .attr('transform', `translate(${xPos},0)`)
                    .attr('y1', 0)
                    .attr('y2', height);
                
                // Format date for tooltip
                const formattedDate = d3.timeFormat('%b %d, %Y')(d.date);
                
                // Find SPY data point
                const spyData = componentData['SPY'];
                const spyI = bisectDate(spyData, x0, 1);
                let spyValue = null;
                
                if (spyI < spyData.length) {
                    const sd0 = spyData[spyI - 1];
                    const sd1 = spyData[spyI];
                    const sd = x0 - sd0.date > sd1.date - x0 ? sd1 : sd0;
                    spyValue = sd.normalized_price;
                }
                
                // Create tooltip content
                let tooltipContent = `<div style="font-weight:bold;margin-bottom:5px;">${formattedDate}</div>`;
                
                // Portfolio value
                tooltipContent += `<div style="margin-bottom:8px;font-weight:bold;display:flex;align-items:center;">
                                    <span style="display:inline-block;width:12px;height:12px;background:${colorScheme.portfolio_value};margin-right:5px;border-radius:2px;"></span>
                                    Portfolio: ${d.portfolio_value.toFixed(4)}</div>`;
                
                // SPY value
                if (spyValue !== null) {
                    tooltipContent += `<div style="display:flex;align-items:center;margin-top:3px;">
                                        <span style="display:inline-block;width:10px;height:10px;background:${colorScheme['SPY']};margin-right:5px;border-radius:2px;"></span>
                                        SPY: ${spyValue.toFixed(4)}</div>`;
                
                    // Add outperformance
                    const diff = d.portfolio_value - spyValue;
                    const diffColor = diff >= 0 ? '#28a745' : '#dc3545';
                    tooltipContent += `<div style="margin-top:5px;color:${diffColor};">
                                      ${diff >= 0 ? 'Outperforming' : 'Underperforming'} SPY by ${Math.abs(diff).toFixed(4)}</div>`;
                }
                
                // Position and show tooltip
                tooltip
                    .html(tooltipContent)
                    .style('left', (event.pageX + 15) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
            }
        }
        
        // Update legend
        function updateLegend() {
            const legend = d3.select('#legend');
            legend.html('');
            
            // Portfolio legend item
            const portfolioItem = legend.append('div')
                .attr('class', 'legend-item');
                
            portfolioItem.append('div')
                .attr('class', 'legend-color')
                .style('background-color', colorScheme.portfolio_value);
                
            portfolioItem.append('span')
                .text('Your Portfolio');
            
            // SPY legend item
            const spyItem = legend.append('div')
                .attr('class', 'legend-item');
                
            spyItem.append('div')
                .attr('class', 'legend-color')
                .style('background-color', colorScheme['SPY']);
                
            spyItem.append('span')
                .text('S&P 500 (SPY)');
        }
        
        // Debounce function for resize handling
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
    </script>
</body>
</html>